<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>La Rivera – Catalog</title>
  <link rel="stylesheet" href="css/styles.css"/>
</head>
<body>
  <nav class="nav container">
    <div class="brand">La <em>Rivera</em></div>
    <div>
      <a href="index.html">Home</a>
      <a href="account.html">Account</a>
      <a href="orders.html">Orders</a>
      <a href="#" id="logout">Logout</a>
    </div>
  </nav>

  <section class="container">
    <div class="topbar">
      <div>
        <div class="badge">Curated for You</div>
        <h2 style="margin:.25rem 0 0">Elegant Dresses</h2>
      </div>
      <div class="cart" style="max-width:420px;flex:0 0 420px">
        <div style="font-weight:700;margin-bottom:.5rem">Your Cart</div>
        <div id="cart"></div>
        <div class="total" id="total"></div>
        <div class="actions">
          <button class="btn" id="checkout">Place Order</button>
        </div>
        <div id="msg" class="sub" style="color:#f59e0b;margin-top:.5rem"></div>
      </div>
    </div>
    <div class="grid" id="grid"></div>
  </section>

  <footer class="footer container">© La Rivera. Elegance, reimagined.</footer>

  <script type="module">
    import { apiGet, apiPost } from './js/api.js';
    const token = localStorage.getItem('token');
    if(!token){ alert('Please sign in to view the catalog.'); window.location.href = 'login.html'; }

    document.getElementById('logout').onclick = () => {
      localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href = 'index.html';
    };

    const grid = document.getElementById('grid');
    const cartDiv = document.getElementById('cart');
    const totalDiv = document.getElementById('total');
    const msg = document.getElementById('msg');

    const fmt = c => '₹' + (c/100).toFixed(2);

    async function loadProducts(){
      const { products } = await apiGet('/api/products');
      grid.innerHTML='';
      products.forEach(p=>{
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <img src="${p.image_url}" alt="${p.name}">
          <div class="pad">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">${p.name}</div>
              <div class="price">${fmt(p.price_cents)}</div>
            </div>
            <div class="sub" style="font-size:.9rem;margin:.25rem 0 .5rem">${p.description||''}</div>
            <div class="actions"><button class="btn" data-id="${p.id}">Add to cart</button></div>
          </div>`;
        el.querySelector('button').onclick = async () => { await apiPost('/api/cart/add', { productId:p.id, qty:1 }, true); await loadCart(); };
        grid.appendChild(el);
      });
    }

    async function loadCart(){
      const { items } = await apiGet('/api/cart', true);
      cartDiv.innerHTML=''; let total=0;
      if(items.length===0){ cartDiv.textContent='Your cart is empty.'; totalDiv.textContent=''; return; }
      const { products } = await apiGet('/api/products');
      for(const i of items){
        const prod = products.find(p=>p.id===i.product_id);
        const row = document.createElement('div'); row.className='row';
        const subtotal = prod.price_cents * i.qty; total += subtotal;
        row.innerHTML = `<div>${prod.name} × ${i.qty}</div><div>${fmt(subtotal)}</div>`;
        cartDiv.appendChild(row);
      }
      totalDiv.textContent = 'Total: ' + fmt(total);
    }

    document.getElementById('checkout').onclick = async () => {
      msg.textContent = '';
      try { const { order } = await apiPost('/api/orders/checkout', {}, true);
        msg.textContent = 'Order placed! #' + order.id + ' — Total ' + fmt(order.total_cents);
        await loadCart();
      } catch(e){ msg.textContent = e.message; }
    };

    (async function init(){ await loadProducts(); await loadCart(); })();
  </script>
</body>
</html>